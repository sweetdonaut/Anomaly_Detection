# 變分自編碼器用於異常檢測：比較研究

## 重點摘要

### 研究目標
- 對當代用於異常檢測的變分自編碼器（VAE）架構進行全面比較分析
- 闡明不同 VAE 架構在異常檢測任務中的性能和行為特徵
- 提供不同架構在實際應用中的優缺點分析

### 主要比較架構
1. **傳統 VAE（基準模型）**
   - 採用標準編碼器-解碼器框架
   - 使用重參數化技巧實現端到端訓練
   - 最小化重建誤差和 Kullback-Leibler 散度

2. **VAE-GRF（高斯隨機場先驗）**
   - 引入零均值穩態高斯隨機場先驗
   - 需要精細的超參數調整才能達到最佳性能
   - 增加了範圍（range）和方差（variance）兩個標量參數

3. **ViT-VAE（視覺變換器 VAE）**
   - 利用視覺變換器架構捕獲長距離依賴關係
   - 將圖像分割為固定大小的塊（patches）
   - 展現出強大的性能，尤其在有限訓練週期下

### 關鍵發現
1. **性能表現**
   - ViT-VAE 在多種場景下表現出色，特別是在非紋理數據上
   - VAE-GRF 需要更複雜的超參數調整才能達到最佳性能
   - ViT-VAE 在榛子、螺絲和地毯類別（數據集容量前三的類別）上表現尤為出色

2. **架構優勢**
   - ViT-VAE 能夠以較少的歸納偏置捕獲長距離依賴關係
   - VAE 相比標準自編碼器在所有指標上都有改進
   - 概率表示允許更好地表示輸入數據的變異性

3. **數據集比較**
   - MVTec AD 數據集：15 個類別，廣泛使用
   - MiAD 數據集：4 個表面異常類別，圖像域和異常類型有所不同
   - MiAD 數據集為未來研究提供了重要潛力

### 實驗設置
- **硬體配置**：8GB RAM，NVIDIA GeForce RTX 3050 4GB GPU
- **訓練參數**：
  - 訓練週期：100 epochs
  - 批次大小：8
  - 學習率：10^-4
- **評估指標**：MAD × SSM（對齊圖 × 基於結構的相似性度量）、ROCAUC

### 實際應用領域
1. **網路安全**：雲計算網路中的異常檢測
2. **醫療監控**：通過家電消耗監測日常活動異常
3. **工業檢測**：製造業中的缺陷檢測

### 結論與未來方向
- VAE 在異常檢測領域仍保持重要地位
- ViT-VAE 代表了異常檢測能力的重大進步
- MiAD 數據集為未來研究提供了新的機會
- 需要進一步探索不同 VAE 架構以推進異常檢測技術

---

## 摘要

本研究旨在對用於異常檢測的當代變分自編碼器（VAE）架構進行比較分析，闡明它們在此特定任務中的性能和行為特徵。透過對三種 VAE 架構的並排評估——原始 VAE 基準、具有高斯隨機場先驗的 VAE（VAE-GRF）和結合視覺變換器的 VAE（ViT-VAE）——本研究探討了異常檢測的基本原理和應用，深入研究了不同實現的複雜性。

研究結果顯示，ViT-VAE 在各種場景中表現出色，而 VAE-GRF 可能需要更複雜的超參數調整才能達到最佳性能狀態。具體而言，ViT-VAE 表現出增強的能力，能夠以較少的歸納偏置捕獲長距離依賴關係，並且 ViT-VAE 表現出值得稱讚的結果，特別是在榛子、螺絲和地毯類別中表現出色——這是數據集容量方面的前三個類別。

## 介紹

異常檢測在現代技術系統中扮演著關鍵角色，涉及識別偏離既定規範或預期行為的模式、事件或觀察結果。在深度學習領域，無監督異常檢測技術因其在沒有標記異常數據的情況下運作的能力而受到重視，這在實際應用中經常遇到。

變分自編碼器（VAE）作為一種強大的生成模型，在異常檢測任務中展現出顯著的效果。VAE 通過學習數據的潛在表示，能夠重建正常數據，而對異常數據的重建效果較差，從而實現異常檢測。

本研究的主要貢獻包括：
1. 實現和比較三種不同的 VAE 架構用於異常檢測
2. 在兩個不同的數據集（MVTec AD 和 MiAD）上評估這些模型
3. 提供關於每種架構優缺點的詳細分析
4. 為未來研究提供實用的見解和建議

## 背景與相關工作

### 異常檢測方法

異常檢測方法可以分為幾個主要類別：
- **基於統計的方法**：使用統計模型來識別異常值
- **基於距離的方法**：根據數據點之間的距離來檢測異常
- **基於密度的方法**：識別低密度區域的數據點
- **基於重建的方法**：學習正常數據的表示並通過重建誤差檢測異常

### 自編碼器在異常檢測中的應用

自編碼器，特別是變分自編碼器，在異常檢測中的應用基於以下原理：
- 在正常數據上訓練模型
- 異常數據由於未在訓練中出現，重建效果較差
- 重建誤差可作為異常分數

### 注意力機制的整合

最近的研究探索了將注意力機制整合到自編碼器架構中：
- 增強模型捕獲長距離依賴關係的能力
- 提高對複雜模式的理解
- 改善異常定位的準確性

## 方法論

### 傳統 VAE（Variational Autoencoder）

傳統 VAE 是一種生成模型，專門設計用於似然估計，包含編碼器和解碼器來捕獲複雜的數據分布。其核心組件包括：

#### 編碼器（Encoder）
- 記作 q_φ(z|x)，將輸入數據 x 轉換為潛在表示 z
- 輸出參數 μ_φ(x) 和 σ_φ(x)，遵循高斯分布
- 使用 ResNet18 作為骨幹網路（在本研究中）

#### 重參數化技巧（Reparameterization Trick）
- 允許通過隨機採樣進行反向傳播
- z = μ + σ ⊙ ε，其中 ε ~ N(0, I)
- 實現端到端的可微分訓練

#### 解碼器（Decoder）
- 記作 p_θ(x̂|z)，從潛在表示 z 重建輸入數據 x̂
- 最小化重建誤差

#### 損失函數
VAE 的總損失包含兩部分：
- **重建損失**：衡量生成數據的負對數似然
- **KL 散度**：懲罰學習分布與預定義分布（通常是標準正態分布）的偏差

總損失 L = E_q[log p(x|z)] - KL(q(z|x)||p(z))

#### 本研究中的設置
- z 維度：256
- 特徵圖大小：32
- β 相關性：1

### VAE-GRF（VAE with Gaussian Random Field Prior）

VAE-GRF 模型通過引入高斯隨機場先驗來改進傳統 VAE，特別適用於紋理圖像的異常檢測。

#### 主要創新點
1. **零均值穩態高斯隨機場先驗**
   - 使用環面（toroidal）結構
   - 具有因子化維度，提高效率和計算並行性

2. **參數效率**
   - 保持與傳統 VAE 相同數量的編碼器、潛在空間和解碼器參數
   - 僅引入兩個額外的標量參數：
     - 範圍（range）參數
     - 方差（variance）參數

3. **架構差異（見圖1）**
   - VAE：潛在空間中的獨立高斯分布
   - VAE-GRF：潛在空間中的相關高斯隨機場

![圖1：VAE 與 VAE-GRF 架構比較](vae_figures/figure_1.png)
*圖1：VAE（上）使用標準高斯先驗 p(z) = N(z,0,I)，而 VAE-GRF（下）使用高斯隨機場先驗 p(z) = N(z,0,Σ)。圖中展示了兩種架構如何處理木紋紋理圖像的編碼與解碼過程。*

#### 優勢
- 更好地建模空間相關性
- 對紋理數據特別有效
- 計算成本增加最小

#### 本研究中的設置
- 相關類型：恆等相關（identity correlation）
- 需要針對不同類別進行 Matern 相關和 βELBO 的額外超參數調整

### ViT-VAE（Vision Transformer VAE）

ViT-VAE 將視覺變換器（Vision Transformer）架構整合到 VAE 框架中，用於異常檢測任務。

#### 架構特點（見圖2）

![圖2：ViT-VAE 架構示意圖](vae_figures/figure_2.png)
*圖2：ViT-VAE 架構流程。輸入圖像被分割為 patches，通過線性投影和位置編碼後，進入 Transformer 編碼器。特徵向量經過參數化（μ(x) 和 σ(x)）後生成潛在表示 z，最後通過解碼器重建圖像。*

1. **圖像分塊（Image Patching）**
   - 將圖像分割為固定大小的非重疊塊（patches）
   - 每個塊線性嵌入為向量
   - 塊嵌入被展平並作為 Transformer 編碼器的輸入

2. **Transformer 編碼器**
   - 多層自注意力和前饋子層
   - 自注意力機制捕獲不同塊之間的關係
   - 輸出作為原始圖像的強大表示

3. **特徵提取**
   - 從 ViT 的中間層提取輸出作為潛在表示
   - 使用圖像特徵而非類別標記（class tokens）
   - 使用卷積層直接從圖像特徵重建圖像

#### 優勢
- 捕獲長距離依賴關係，歸納偏置較少
- 在有限的訓練週期下表現強勁
- 對大數據量類別特別有效

#### 本研究中的設置
- 潛在維度：384
- 潛在圖像大小：14
- 基於 [11] 的先前實現

### 評估指標

本研究採用 [5] 中提出的 AD 指標，結合兩個度量：

1. **SSM（Structure-based Similarity Measure）**
   - 基於重建圖像的結構相似性度量
   - 評估重建質量

2. **MAD（Alignment Map）**
   - 來自潛在空間的對齊圖
   - 可用於像素級異常標記

最終指標：MAD × SSM

使用 ROCAUC 評估這些值的效果。

## 實驗設置

### 數據集

#### 1. MVTec AD 數據集

**基本資訊**
- 總圖像數：5,354 張高解析度圖像
- 訓練集：3,629 張（僅包含正常樣本）
- 測試集：1,725 張（包含正常和異常樣本）
- 類別數：15 個不同的工業物體和場景

**類別分布**
- **紋理類別（6個）**：carpet、grid、leather、tile、wood、hazelnut
- **非紋理類別（9個）**：bottle、cable、capsule、metal nut、pill、screw、toothbrush、transistor、zipper

**數據特點**
- 訓練集僅包含無缺陷的圖像，建立工業環境中的正常基準
- 測試集包含無缺陷圖像和各種類型的缺陷
- 異常類型：表面缺陷、結構異常、缺失部件等
- 所有缺陷都有像素級精確標註

**數據集限制**
- 每個類別的圖像數量有限（最多 381 張訓練圖像）
- 過度使用導致模型過度針對 MVTec 優化

#### 2. MiAD 數據集（Maintenance Inspection Anomaly Detection）

**基本資訊**
- 總圖像數：超過 10,000 張高解析度彩色圖像
- 場景數：7 個戶外工業場景
- 本研究使用：4 個表面異常類別

**使用的類別**
1. **Electrical Insulator**（電氣絕緣子）
2. **Metal Welding**（金屬焊接）
3. **Photovoltaic Module**（光伏模組）
4. **Wind Turbine**（風力渦輪機）

**數據特點**
- 圖像由 3D 圖形軟體生成
- 涵蓋表面和邏輯異常
- 具有像素級精確的真實標註
- 每個類別有 10,000 張訓練圖像（顯著多於 MVTec）
- 每個類別至少有 1,200 張測試圖像

**獨特優勢**
- 強調戶外視角和非受控環境
- 包含多樣的相機視角
- 複雜的背景
- 物體表面退化效果
- 更接近真實世界的應用場景

### 實驗配置

- **硬體環境**：8GB RAM，NVIDIA GeForce RTX 3050 4GB GPU
- **訓練參數**：
  - 訓練週期：100 epochs
  - 批次大小：8
  - 學習率：10^-4
  - 優化器：Adam
- **評估指標**：
  - MAD × SSM（對齊圖 × 基於結構的相似性度量）
  - ROCAUC（接收者操作特徵曲線下面積）

## 結果與討論

### MVTec 數據集結果

#### 表1：MVTec 數據集上三種模型的比較結果（MAD × SSM 指標）

| 類別 | 類型 | VAE | VAE-GRF | ViT-VAE |
|------|------|-----|---------|----------|
| **紋理類別** |
| carpet | 紋理 | 0.88±0.13 | 0.86±0.11 | **0.92±0.10** |
| grid | 紋理 | 0.89±0.10 | 0.80±0.12 | **0.94±0.05** |
| leather | 紋理 | 0.84±0.16 | **0.90±0.12** | 0.72±0.24 |
| tile | 紋理 | **0.84±0.10** | 0.68±0.17 | 0.80±0.14 |
| wood | 紋理 | **0.80±0.20** | 0.73±0.20 | 0.68±0.19 |
| hazelnut | 紋理 | 0.97±0.02 | 0.97±0.02 | **0.98±0.01** |
| **平均** | | 0.87±0.11 | 0.82±0.12 | **0.88±0.12** |
| **非紋理類別** |
| bottle | 非紋理 | 0.80±0.11 | 0.81±0.11 | **0.85±0.09** |
| cable | 非紋理 | 0.63±0.19 | 0.60±0.24 | **0.67±0.17** |
| capsule | 非紋理 | 0.84±0.17 | 0.87±0.15 | **0.92±0.13** |
| metal nut | 非紋理 | 0.76±0.09 | 0.80±0.09 | **0.82±0.07** |
| pill | 非紋理 | 0.84±0.16 | **0.87±0.12** | 0.87±0.17 |
| screw | 非紋理 | 0.92±0.06 | 0.88±0.10 | **0.94±0.04** |
| toothbrush | 非紋理 | 0.84±0.10 | 0.84±0.07 | **0.87±0.06** |
| transistor | 非紋理 | 0.69±0.15 | 0.67±0.14 | **0.72±0.17** |
| zipper | 非紋理 | 0.86±0.10 | 0.82±0.11 | **0.89±0.11** |
| **平均** | | 0.79±0.12 | 0.79±0.12 | **0.84±0.11** |

#### 主要發現

1. **ViT-VAE 的優越性能**
   - 在 15 個類別中的 11 個類別表現最佳
   - 在非紋理數據上顯著優於其他模型
   - 在數據量最大的三個類別（hazelnut、screw、carpet）上表現尤為出色

2. **VAE-GRF 的表現**
   - 與原論文 [5] 相比性能顯著降低
   - 可能原因：訓練週期差異（100 vs 原論文更多）和超參數設置
   - 需要針對每個類別進行精細的超參數調整（Matern 相關和 βELBO）

3. **數據量的影響**
   - ViT-VAE 在數據量大的類別上表現更好
   - 數據量少的類別上，ViT-VAE 的優勢不明顯

### MiAD 數據集結果

#### 表2：MiAD 數據集上三種模型的比較結果（MAD × SSM 指標）

| 異常類別 | VAE | VAE-GRF | ViT-VAE |
|----------|-----|---------|---------|
| Electrical Insulator | 0.87 | 0.84 | 0.86 |
| Metal Welding | 0.69 | **0.82** | 0.71 |
| Photovoltaic Module | **0.98** | 0.93 | 0.97 |
| Wind Turbine | 0.92 | 0.93 | **0.93** |
| **平均** | 0.87 | **0.88** | 0.87 |

#### 主要發現

1. **模型性能更加接近**
   - 三種模型的平均性能差異很小（0.87-0.88）
   - VAE-GRF 略微領先，但優勢不明顯

2. **數據集特性的影響**
   - MiAD 包含隨機背景和多視角變化
   - 這些特性對所有模型都構成挑戰
   - VAE 和 ViT-VAE 在處理隨機背景時遇到困難

### 性能比較

VAE 相比標準自編碼器的優勢：
- 基於所有指標和混淆矩陣的比較，VAE 在各方面都改進了 AE
- 這種差異是由於 VAE 中的重建概率與簡單 AE 的重建誤差不同
- 允許表示數據的變異性

### 深入分析

#### 圖1：VAE vs VAE-GRF 架構差異
論文中的圖1展示了兩種架構的主要差異：
- **左側（VAE）**：潛在空間中每個維度獨立，呈現標準高斯分布
- **右側（VAE-GRF）**：潛在空間具有空間相關性，使用高斯隨機場建模
- **下方**：展示了兩種方法生成的異常圖（anomaly map）差異

#### 圖2：ViT-VAE 架構
ViT-VAE 的架構流程：
1. 輸入圖像被分割為 patches
2. 每個 patch 通過線性投影轉換為嵌入向量
3. 位置編碼被添加到 patch 嵌入中
4. Transformer 編碼器處理這些嵌入
5. 中間層輸出作為潛在表示
6. 解碼器使用卷積層重建圖像

#### 圖3：數據集樣本示例

![圖3：MVTec 和 MiAD 數據集樣本](vae_figures/figure_3.png)
*圖3：MVTec 和 MiAD 數據集的樣本示例。上兩行展示紋理和非紋理類別的正常樣本，第三行展示對應的異常樣本和標註。可以看出 MiAD 數據集（粉色標記）包含更複雜的場景，而 MVTec（綠色標記）更聚焦於工業產品。*

展示了 MVTec 和 MiAD 數據集中的正常和異常樣本：
- 包含紋理和非紋理材料
- 異常區域在數量、大小和形式上差異很大
- MiAD 數據集包含更複雜的背景和視角變化

#### 圖4：異常檢測結果可視化

![圖4：三種 VAE 模型的異常檢測結果](vae_figures/figure_4.png)
*圖4：在 MVTec 和 MiAD 數據集上三種 VAE 模型的異常檢測結果比較。從上到下分別為：原始圖像、VAE 結果、VAE-GRF 結果、ViT-VAE 結果和真實標註。熱圖顏色越亮表示異常分數越高。*

展示了三種模型在 MVTec 和 MiAD 樣本上的異常圖：
- 顯示了每種模型的異常定位能力
- VAE-GRF 在某些情況下可能錯誤標記異常位置
- ViT-VAE 通常提供更精確的異常定位

### 技術洞察

1. **VAE-GRF 的穩定性要求**
   - 更穩定的配置與性能改善相關
   - 訓練數據中的視角差異顯著影響 VAE-GRF 的重建輸出
   - 需要針對特定數據特性調整超參數

2. **ViT-VAE 的數據需求**
   - 需要較大的數據量才能發揮最佳性能
   - 在數據量充足的情況下，能夠有效捕獲長距離依賴
   - 歸納偏置較少，更依賴數據驅動的學習

3. **MiAD 作為魯棒性測試**
   - 可用於評估模型對域偏移的抵抗能力
   - 通過不在完整訓練集上訓練，測試模型的泛化能力
   - 為未來研究提供更具挑戰性的基準

### 實際應用案例

1. **網路安全**
   - 網路異常檢測系統在使用機器學習方法智能監控網路流量方面受到廣泛關注
   - 基於自編碼器的高效模型用於雲計算網路中的異常檢測

2. **醫療保健監控**
   - 以最少侵入的方式監控人們的日常生活活動
   - 通過分析家用電器的日常消耗來檢測日常活動的異常模式

3. **工業檢測**
   - 製造業中的表面缺陷檢測
   - 產品質量控制和自動化檢查
   - 減少人工檢查的成本和錯誤率

## 結論

本研究的主要結論：
1. VAE 在異常檢測領域仍然佔據重要地位
2. ViT-VAE 展現出強大而穩健的性能
3. MiAD 數據集為未來研究提供了有前景的機會
4. 不同的 VAE 架構適用於不同的應用場景

### 研究限制

1. **硬體限制**
   - 由於 GPU 記憶體限制（4GB），批次大小降至 8
   - 訓練週期從原論文的設置減少
   - 可能影響模型的最終性能，特別是 VAE-GRF

2. **超參數探索**
   - VAE-GRF 需要大量超參數調整，本研究未能充分探索
   - 使用統一的超參數設置可能不利於某些模型

3. **數據集覆蓋**
   - MiAD 數據集中未包含邏輯異常類別
   - 某些 MVTec 類別的數據量較少，影響結論的普遍性

### 未來研究方向

1. **架構創新**
   - 探索結合 ViT 和 GRF 優勢的混合架構
   - 研究更高效的 patch 大小和注意力機制
   - 開發自適應的異常檢測閾值

2. **實際應用**
   - 研究實時異常檢測的可能性
   - 優化模型以適應邊緣設備部署
   - 開發多模態異常檢測系統

3. **評估改進**
   - 開發更全面的評估指標
   - 建立跨數據集的標準化評估協議
   - 研究少樣本學習在異常檢測中的應用

## 主要參考文獻

1. Nassif, A. B., et al. (2021). "Machine learning for anomaly detection: A systematic review." IEEE Access, 9, 78658-78700.
2. Kingma, D. P., & Welling, M. (2013). "Auto-encoding variational bayes." arXiv preprint arXiv:1312.6114.
3. Dosovitskiy, A., et al. (2020). "An image is worth 16x16 words: Transformers for image recognition at scale." arXiv preprint arXiv:2010.11929.
4. Gangloff, H., et al. (2023). "Variational autoencoder with gaussian random field prior: application to unsupervised animal detection in aerial images." IEEE ICIP 2023.
5. Gangloff, H., et al. (2023). "Unsupervised anomaly detection using variational autoencoder with gaussian random field prior." IEEE ICIP 2023.
6. Bergmann, P., et al. (2019). "MVTec AD–A comprehensive real-world dataset for unsupervised anomaly detection." IEEE/CVF CVPR, 9592-9600.
7. Bao, T., et al. (2023). "MiAD: A maintenance inspection dataset for unsupervised anomaly detection." IEEE/CVF ICCV, 993-1002.
8. An, J., & Cho, S. (2015). "Variational autoencoder based anomaly detection using reconstruction probability." Special lecture on IE, 2(1), 1-18.
9. Lee, Y., & Kang, P. (2022). "AnoViT: Unsupervised anomaly detection and localization with vision transformer-based encoder-decoder." IEEE Access, 10, 46717-46724.
10. Thisanke, H., et al. (2023). "Semantic segmentation using vision transformers: A survey." Engineering Applications of Artificial Intelligence, 126, 106669.

## 參考資料與資源

- **研究代碼庫**：https://github.com/endtheme123/VAE-compare.git
- **MVTec AD 數據集**：https://www.mvtec.com/company/research/datasets/mvtec-ad
- **MiAD 數據集**：工業維護檢測的新興基準
- **PyTorch 實現**：基於 PyTorch 2.0 框架
- **原始論文**：https://arxiv.org/abs/2408.13561

---

*注：本文為 "Variational Autoencoder for Anomaly Detection: A Comparative Study" 的繁體中文翻譯與整理，原文作者為 Huy Hoang Nguyen, Cuong Nhat Nguyen, Xuan Tung Dao, Quoc Trung Duong, Dzung Pham Thi Kim, Minh-Tan Pham 等人。翻譯整理時力求準確完整，但如有疑義請參考原文。*